<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YouTube ライブコメント取得</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #fff;
    }
    #comments {
      max-width: 600px;
      margin: auto;
    }
    .comment {
      border-bottom: 1px solid #333;
      padding: 6px 0;
    }
    .author {
      color: #4fc3f7;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>YouTube ライブコメント表示</h2>

<input id="videoId" placeholder="動画ID">
<button onclick="start()">開始</button>

<div id="comments"></div>

<script>
const API_KEY = "AIzaSyABeIrmDX6-ytlEFkqvakC1QE66NrvvSsE"; // ← リファラ制限必須

let liveChatId = null;
let nextPageToken = null;
let pollingInterval = 5000;

async function start() {
  const videoId = document.getElementById("videoId").value;
  await fetchLiveChatId(videoId);
  fetchChatLoop();
}

async function fetchLiveChatId(videoId) {
  const url = `https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoId}&key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();

  if (!data.items || !data.items[0]?.liveStreamingDetails?.activeLiveChatId) {
    alert("ライブ配信中の動画ではありません");
    return;
  }

  liveChatId = data.items[0].liveStreamingDetails.activeLiveChatId;
}

async function fetchChatLoop() {
  if (!liveChatId) return;

  let url = `https://www.googleapis.com/youtube/v3/liveChat/messages?part=snippet,authorDetails&liveChatId=${liveChatId}&key=${API_KEY}`;
  if (nextPageToken) {
    url += `&pageToken=${nextPageToken}`;
  }

  const res = await fetch(url);
  const data = await res.json();

  nextPageToken = data.nextPageToken;
  pollingInterval = data.pollingIntervalMillis || 5000;

  if (data.items) {
    data.items.forEach(addComment);
  }

  setTimeout(fetchChatLoop, pollingInterval);
}

function addComment(item) {
  if (item.snippet.type !== "textMessageEvent") return;

  const div = document.createElement("div");
  div.className = "comment";

  div.innerHTML = `
    <span class="author">${item.authorDetails.displayName}</span>：
    ${item.snippet.displayMessage}
  `;

  const comments = document.getElementById("comments");
  comments.prepend(div);
}
</script>

</body>
</html>
